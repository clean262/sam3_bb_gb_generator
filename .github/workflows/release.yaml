name: Release (tag -> build -> zip -> GitHub Release)

on:
  push:
    tags:
      - "v*"
      - "*.*.*"
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-2022
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure (CMake / VS2022 x64)
        shell: pwsh
        run: |
          git config --global core.longpaths true
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build (Release)
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel

      - name: Package (AviUtl2 layout)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $zipBase = "SAM3_win64"

          # ビルド成果物の存在チェック
          if (!(Test-Path "build/Release/sam3.aux2")) { throw "Missing build/Release/sam3.aux2" }
          if (!(Test-Path "build/Release/sam3mask.mod2")) { throw "Missing build/Release/sam3mask.mod2" }
          if (!(Test-Path "lua/SAM3mask.anm2")) { throw "Missing lua/SAM3mask.anm2" }
          if (!(Test-Path "python")) { throw "Missing python directory" }
          if (!(Test-Path "installer/install.ps1")) { throw "Missing installer/install.ps1" }
          if (!(Test-Path "installer/install.cmd")) { throw "Missing installer/install.cmd" }

          $dist = "dist"
          if (Test-Path $dist) { Remove-Item -Recurse -Force $dist }

          $root = Join-Path $dist $zipBase
          New-Item -ItemType Directory -Force -Path "$root/aviutl2/Plugin/SAM3" | Out-Null
          New-Item -ItemType Directory -Force -Path "$root/aviutl2/Script/SAM3" | Out-Null

          # Plugin 側
          Copy-Item "build/Release/sam3.aux2" "$root/aviutl2/Plugin/SAM3/" -Force
          Copy-Item -Recurse "python" "$root/aviutl2/Plugin/SAM3/" -Force

          # 最新 uv.exe を python フォルダへ入れる
          $uvDir = Resolve-Path "$root/aviutl2/Plugin/SAM3/python"
          $env:UV_INSTALL_DIR = $uvDir.Path
          $env:UV_NO_MODIFY_PATH = "1"   # PATH変更を抑止
          irm https://astral.sh/uv/install.ps1 | iex
          $uvx = Join-Path $uvDir.Path "uvx.exe"
          $uvw = Join-Path $uvDir.Path "uvw.exe"
          if (Test-Path $uvx) { Remove-Item $uvx -Force }
          if (Test-Path $uvw) { Remove-Item $uvw -Force }

          if (!(Test-Path (Join-Path $uvDir.Path "uv.exe"))) {
            throw "Failed to install uv.exe into $($uvDir.Path)"
          }

          # Script 側（SAM3color.anm2 は入れない）
          Copy-Item "lua/SAM3mask.anm2" "$root/aviutl2/Script/SAM3/" -Force
          Copy-Item "build/Release/sam3mask.mod2" "$root/aviutl2/Script/SAM3/" -Force

          # （任意）README を同梱したいなら
          if (Test-Path "README.md") { Copy-Item "README.md" "$root/" -Force }

          # インストーラー同梱（ZIP展開後に install.cmd を実行してもらう）
          Copy-Item "installer/install.ps1" "$root/install.ps1" -Force
          Copy-Item "installer/install.cmd" "$root/install.cmd" -Force

          $zip = "${zipBase}.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Push-Location $dist
          Compress-Archive -Path $zipBase -DestinationPath "../$zip"
          Pop-Location

          $hash = (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower()
          "$hash  $zip" | Out-File -Encoding ascii "${zip}.sha256"
          
      - name: Upload Artifacts (manual run)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: SAM3_win64-${{ github.ref_name }}-${{ github.run_number }}
          path: |
            SAM3_win64.zip
            SAM3_win64.zip.sha256
          if-no-files-found: error
          retention-days: 14

      - name: Create/Update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            SAM3_win64.zip
            SAM3_win64.zip.sha256
          fail_on_unmatched_files: true
          generate_release_notes: true